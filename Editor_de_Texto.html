<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Editor de Texto ‚Äì Modo Escuro (v3.4)</title>
  <!-- Font Awesome para o √≠cone ‚Äúvoltar‚Äù -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <style>
    :root{
      --bg:#121212;
      --surface:#1e1e1e;
      --surface-light:#1c1c1c;
      --accent:#2d2d2d;
      --text:#e0e0e0;
      --radius:5px;
      --pad:6px 10px;
      --reveal-bg:rgba(255,255,255,0.2); /* contraste bem suave p/ texto revelado */
    }


    *{box-sizing:border-box;margin:0;}
    body{padding:72px 20px 24px;background:var(--bg);color:var(--text);font-family:Arial,Helvetica,sans-serif;}

    /* ---------- TOOLBAR ---------- */
    #toolbar{
      position:fixed;top:0;left:0;right:0;z-index:100;
      display:flex;flex-wrap:wrap;gap:10px;align-items:center;
      padding:2px 2px;
      background:linear-gradient(180deg,var(--surface-light),transparent);
      backdrop-filter:blur(5px);
      border-bottom:1px solid var(--accent);
      box-shadow:0 3px 6px rgba(0,0,0,.4);
    }
    button{
      background:var(--surface);
      color:var(--text);
      border:1px solid var(--accent);
      border-radius:var(--radius);
      padding:var(--pad);
      cursor:pointer;
      display:flex;align-items:center;justify-content:center;
      transition:background .2s,transform .1s;
      user-select:none;
      padding:16px 16px;
    }
    button:hover{background:var(--accent);} 
    button:active{transform:scale(.96);} 
    #message{font-style:italic;margin-left:6px;}

    /* ---------- EDITOR ---------- */
    #editor{
      border:1px solid var(--accent);
      margin-top: 0px;
      padding:0px;
      min-height:300px;
      background:var(--surface);
      color:var(--text);
      border-radius:var(--radius);
    }
    #editor p{margin:2px 0;line-height:1.3;}
    .hidden-text{
      background:#404040;
      color:transparent;
      user-select:none;
      cursor:pointer;
      border-radius:var(--radius);
      padding:0 2px;
      transition:background .2s;
    }
    .hidden-text.revealed{
      background:var(--reveal-bg);
      color:inherit;
    }

    /* ---------- IMAGENS & TARJAS ---------- */
    .image-container{position:relative;display:inline-block;user-select:none;}
    .image-container img{display:block;max-width:100%;height:auto;cursor:default;}
    .tarja{
      position:absolute;
      background:rgba(0,0,0,.95);
      cursor:move;
      border-radius:var(--radius);
    }
#editor, #editor p{
  overflow-wrap: break-word;
  word-break: break-word;
  white-space: pre-wrap;
}

    /* ---------- PALETA DE CORES ---------- */
    #palette{
      position:absolute;top:100%;left:0;margin-top:4px;
      display:grid;grid-template-columns:repeat(8,24px);gap:4px;
      background:var(--surface);
      border:1px solid var(--accent);
      padding:6px;
      border-radius:var(--radius);
      z-index:200;
      visibility:hidden;opacity:0;transition:opacity .15s;
    }
    #palette.show{visibility:visible;opacity:1;}
    .swatch{width:24px;height:24px;border:2px solid var(--surface);border-radius:var(--radius);cursor:pointer;user-select:none;}
    .swatch:hover{border-color:var(--text);}  
  </style>
</head>
<body>
  <div id="toolbar">
    <button id="backBtn" title="Voltar"><i class="fas fa-arrow-left"></i></button>
    <button id="undoBtn" title="Desfazer (Ctrl+Z)"><i class="fas fa-undo"></i></button>
<button id="redoBtn" title="Refazer (Ctrl+Y)"><i class="fas fa-redo"></i></button>
    <button id="boldBtn" title="Negrito (Ctrl+B)"><b>B</b></button>
    <button id="italicBtn" title="It√°lico (Ctrl+I)"><i>I</i></button>
    <button id="underlineBtn" title="Sublinhado (Ctrl+U)"><u>U</u></button>
    <button id="colorBtn" title="Cor do texto">üé®</button>
    <div id="palette"></div>
    <button id="hideBtn" title="">ü§´ Ocultar Texto</button>
    <button id="clearBtn" title="">üßπ Limpar Formata√ß√£o</button>
    <button id="insertImgBtn" title="">üì∑ Inserir Imagem</button>
    <input type="file" id="fileInput" accept="image/*" hidden />
    <button id="insertBtn">‚óºÔ∏è Ocultar Imagem (Tarja)</button>
    <button id="concluirBtn" style="display:none">Concluir</button>
    <button id="desfazerBtn" style="display:none">Desfazer</button>
    <span id="message"></span>
  </div>

  <div id="editor" contenteditable="true"><p></p></div>

  <script src="https://cdn.jsdelivr.net/npm/interactjs/dist/interact.min.js"></script>
  <script>
    /* ---------- UTILIDADES ---------- */
    const editor = document.getElementById('editor');
    document.execCommand('styleWithCSS', false, true);
    const exec = (cmd,val=null)=>{editor.focus();document.execCommand(cmd,false,val);} 

/* par√¢metro recebido do iframe -------------------------------------------------- */
const params = new URLSearchParams(location.search);
const disc   = params.get('disc') || 'Geral';
const sub    = params.get('sub')  || '00';
  const storageKey = `summary_${disc}_${sub}`;   // <-- chave √∫nica

  /* NOVO: usa o localStorage do documento pai caso exista */
  const storage = window.parent && window.parent.localStorage
                ? window.parent.localStorage
                : localStorage;


    /* ---------- BOTOES B√ÅSICOS ---------- */
backBtn.onclick = () => {
  if (window.parent?.closeSummary) window.parent.closeSummary();
  else history.back();
};
    boldBtn.onclick = ()=>exec('bold');
    italicBtn.onclick = ()=>exec('italic');
    underlineBtn.onclick = ()=>exec('underline');

    /* ---------- SELE√á√ÉO ---------- */
    let savedRange=null;
    const saveSel = ()=>{const s=window.getSelection(); if(s.rangeCount) savedRange=s.getRangeAt(0).cloneRange();}
    const restoreSel = ()=>{if(!savedRange) return; const s=window.getSelection(); s.removeAllRanges(); s.addRange(savedRange);}  

    /* ---------- PALETA DE CORES ---------- */
    const defaultColors=["#ffffff","#BF5BF3","#FF443B","#FF9F0C","#FFD60C","#0C84FE","#2DD158","#8E8D92"];
    const palette = document.getElementById('palette');
    defaultColors.forEach(c=>{
      const sw=document.createElement('div'); sw.className='swatch'; sw.style.background=c; sw.dataset.color=c;
      let hold=null;
      sw.addEventListener('click',()=>{restoreSel(); exec('foreColor',sw.dataset.color); hidePalette();});
      sw.addEventListener('mousedown',()=>{hold=setTimeout(()=>{
          const novo=prompt('Hex (#rrggbb ou #rgb):',sw.dataset.color);
          if(novo && /^#([\da-f]{3}|[\da-f]{6})$/i.test(novo)) {sw.style.background=novo; sw.dataset.color=novo; restoreSel(); exec('foreColor',novo); hidePalette();}
      },1000);});
      ['mouseup','mouseleave'].forEach(ev=>sw.addEventListener(ev,()=>clearTimeout(hold)));
      palette.appendChild(sw);
    });
    const showPalette = ()=>{const r=colorBtn.getBoundingClientRect(); palette.style.left=(r.left+window.scrollX)+'px'; palette.style.top=(r.bottom+window.scrollY)+'px'; palette.classList.add('show');}
    const hidePalette = ()=> palette.classList.remove('show');
    colorBtn.onclick = ()=>{ if(palette.classList.contains('show')) hidePalette(); else { saveSel(); showPalette(); } };
    document.addEventListener('click',e=>{ if(!palette.contains(e.target) && e.target!==colorBtn) hidePalette(); });

    /* ---------- OCULTAR / REVELAR TEXTO ---------- */
/* ---------- OCULTAR / REVELAR TEXTO ---------- */
hideBtn.onclick = () => {
  const sel = window.getSelection();
  if (!sel.rangeCount || sel.isCollapsed) return;
  const range = sel.getRangeAt(0);

  /* 1) Cursor/sele√ß√£o dentro de UM √∫nico .hidden-text  */
  const sameHidden = range.startContainer.parentElement.closest?.('.hidden-text');
  if (sameHidden && sameHidden === range.endContainer.parentElement.closest?.('.hidden-text')) {
    // remove o span, mantendo o conte√∫do
    while (sameHidden.firstChild) sameHidden.parentNode.insertBefore(sameHidden.firstChild, sameHidden);
    sameHidden.remove();
    return;
  }

  /* 2) Sele√ß√£o cruza um ou mais .hidden-text (sem ser o mesmo bloco inteiro) */
  const spans = [];
  const walker = document.createTreeWalker(range.commonAncestorContainer, NodeFilter.SHOW_ELEMENT, {
    acceptNode(node) {
      return node.classList?.contains('hidden-text') && range.intersectsNode(node)
        ? NodeFilter.FILTER_ACCEPT : NodeFilter.FILTER_REJECT;
    }
  });
  for (let n = walker.nextNode(); n; n = walker.nextNode()) spans.push(n);

  if (spans.length) {
    spans.forEach(span => {
      while (span.firstChild) span.parentNode.insertBefore(span.firstChild, span);
      span.remove();
    });
    return;
  }

  /* 3) Nada oculto ‚Üí cria novo bloco oculto */
  const span = document.createElement('span');
  span.className = 'hidden-text';
  span.textContent = range.toString();
  span.onclick = () => span.classList.toggle('revealed');

  range.deleteContents();
  range.insertNode(span);

  // posiciona o cursor logo ap√≥s o novo span
  const zwsp = document.createTextNode('\u200B');
  span.after(zwsp);
  const newR = document.createRange();
  newR.setStartAfter(zwsp);
  newR.collapse(true);
  sel.removeAllRanges();
  sel.addRange(newR);

  exec('removeFormat');
};



    /* ---------- LIMPAR FORMATA√á√ÉO ---------- */
    clearBtn.onclick = ()=>{
      const sel=window.getSelection(); if(!sel.rangeCount || sel.isCollapsed) return;
      exec('removeFormat');
      const range=sel.getRangeAt(0);
      const anc=range.commonAncestorContainer.nodeType===1?range.commonAncestorContainer:range.commonAncestorContainer.parentElement;
      anc.querySelectorAll('.hidden-text').forEach(span=>{ if(range.intersectsNode(span)) span.replaceWith(document.createTextNode(span.textContent)); });
    };

    /* ---------- INSERIR IMAGEM ---------- */
    insertImgBtn.onclick = ()=>{ saveSel(); fileInput.click(); };
    fileInput.onchange = e=>{ const f=e.target.files[0]; if(!f) return; const r=new FileReader(); r.onload=ev=>{insertImg(ev.target.result); fileInput.value='';}; r.readAsDataURL(f); };
    editor.addEventListener('paste',e=>{ for(const it of e.clipboardData.items){ if(it.type.startsWith('image/')){ const f=it.getAsFile(); const r=new FileReader(); r.onload=ev=>insertImg(ev.target.result); r.readAsDataURL(f); e.preventDefault(); } } });
    editor.addEventListener('drop',e=>{ for(const f of e.dataTransfer.files){ if(f.type.startsWith('image/')){ const r=new FileReader(); r.onload=ev=>insertImg(ev.target.result); r.readAsDataURL(f); e.preventDefault(); } } });

    function insertImg(src){
      const img=document.createElement('img'); img.src=src; img.alt='imagem'; makeResizable(img);
      const sel=window.getSelection(); if(sel.rangeCount){ const range=sel.getRangeAt(0); range.collapse(false); range.insertNode(img); const br=document.createElement('br'); img.after(br); range.setStartAfter(br); range.collapse(true); sel.removeAllRanges(); sel.addRange(range);} else { editor.appendChild(img); const p=document.createElement('p'); p.innerHTML='<br>'; editor.appendChild(p);} }

  
          // Tarjas
    const insertBtn = document.getElementById('insertBtn'), concluirBtn = document.getElementById('concluirBtn'), desfazerBtn = document.getElementById('desfazerBtn');
    const message = document.getElementById('message');
    let editingTarjas = false, selectedImage = null; const tarjasMap = new Map();
    insertBtn.onclick = () => { editingTarjas = true; message.textContent = 'Clique na imagem que deseja editar.'; toggleTarjaBtns(true); };
    concluirBtn.onclick = endEditing;
    desfazerBtn.onclick = () => { if (!selectedImage) return; const arr = tarjasMap.get(selectedImage)‚ÄÜ|| []; const last = arr.pop(); if (last) last.remove(); };
    function toggleTarjaBtns(active) { insertBtn.style.display = active?'none':'inline-block'; concluirBtn.style.display = active?'inline-block':'none'; desfazerBtn.style.display = active?'inline-block':'none'; }
    editor.addEventListener('click', e => { if (!editingTarjas && e.target.classList.contains('tarja')) { e.stopPropagation(); const tar = e.target; const comp = getComputedStyle(tar).backgroundColor; tar.style.backgroundColor = comp==='rgba(0, 0, 0, 0.4)'?'rgba(0,0,0,1)':'rgba(0,0,0,0.4)'; } if (editingTarjas && e.target.tagName==='IMG') selectImage(e.target); });
    function selectImage(img) { selectedImage = img; message.textContent = 'Desenhe a tarja na imagem.'; if (!img._listeners) setupDrawing(img); (tarjasMap.get(img)‚ÄÜ||[]).forEach(t=>setupInteract(t)); }
    function setupDrawing(img) { const container = wrapImage(img); let startX, startY, drawing = false, newTarja;
      function mousedown(e) { if (!editingTarjas || e.target !== img) return; drawing = true; const rect = container.getBoundingClientRect(); startX = e.clientX - rect.left; startY = e.clientY - rect.top; newTarja = document.createElement('div'); newTarja.className='tarja'; Object.assign(newTarja.style,{left:startX+'px',top:startY+'px',background:'rgba(0,0,0,1)'}); container.appendChild(newTarja); (tarjasMap.get(img)‚ÄÜ||tarjasMap.set(img,[]).get(img)).push(newTarja); setupInteract(newTarja); }
      function mousemove(e) { if (!drawing) return; const rect = container.getBoundingClientRect(); const x=e.clientX-rect.left, y=e.clientY-rect.top; Object.assign(newTarja.style,{width:Math.abs(x-startX)+'px',height:Math.abs(y-startY)+'px',left:Math.min(x,startX)+'px',top:Math.min(y,startY)+'px'}); }
      function mouseup() { drawing=false; }
      container.addEventListener('mousedown',mousedown);
      container.addEventListener('mousemove',mousemove);
      document.addEventListener('mouseup',mouseup);
      img._listeners = {mousedown,mousemove,mouseup,container};
    }
    function wrapImage(img) { if (img.parentElement.classList.contains('image-container')) return img.parentElement; const wrap=document.createElement('div'); wrap.className='image-container'; wrap.contentEditable=false; img.replaceWith(wrap); wrap.appendChild(img);const p=document.createElement('p');p.innerHTML='<br>';wrap.after(p); return wrap; }
    function setupInteract(el) { interact(el).draggable({listeners:{move(evt){ if(!editingTarjas)return; const dx=evt.dx,dy=evt.dy; const x=(+el.dataset.x||0)+dx, y=(+el.dataset.y||0)+dy; el.style.transform=`translate(${x}px,${y}px)`; el.dataset.x=x; el.dataset.y=y;}}}).resizable({edges:{left:true,right:true,top:true,bottom:true},listeners:{move(evt){ if(!editingTarjas)return; let x=+evt.target.dataset.x||0,y=+evt.target.dataset.y||0; evt.target.style.width=evt.rect.width+'px';evt.target.style.height=evt.rect.height+'px'; x+=evt.deltaRect.left; y+=evt.deltaRect.top; evt.target.style.transform=`translate(${x}px,${y}px)`; evt.target.dataset.x=x;evt.target.dataset.y=y;}}}); }
    function endEditing() { editingTarjas=false; message.textContent=''; toggleTarjaBtns(false); document.querySelectorAll('.image-container img').forEach(img=>{ if(img._listeners){ const{mousedown,mousemove,mouseup,container}=img._listeners; container.removeEventListener('mousedown',mousedown);container.removeEventListener('mousemove',mousemove);document.removeEventListener('mouseup',mouseup); delete img._listeners; }}); tarjasMap.forEach(arr=>arr.forEach(t=>interact(t).unset())); selectedImage=null; }

/* ---------- RESIZE PROPORCIONAL ---------- */
function makeResizable(img){
  if (img._resizable) return;

  img.style.maxWidth = '100%';
  img.style.height    = 'auto';
  img.draggable       = false;
  img.addEventListener('dragstart', e => e.preventDefault());

  // garante que o ratio seja salvo quando a imagem j√° estiver pronta
  const setRatio = () => {
    const r = (img.naturalWidth || img.width) / (img.naturalHeight || img.height) || 1;
    img.dataset.ratio = r;
  };
  if (img.complete) setRatio();
  else img.addEventListener('load', setRatio, { once: true });

  interact(img).resizable({
    edges: { left:true, right:true, top:true, bottom:true },
    inertia: true,
    listeners: {
      move (evt) {
        // se por algum motivo ainda n√£o houver ratio, calcula agora
        let r = parseFloat(evt.target.dataset.ratio);
        if (!r || !isFinite(r)) {
          r = evt.target.offsetWidth / evt.target.offsetHeight || 1;
          evt.target.dataset.ratio = r;
        }

        // mant√©m propor√ß√£o
        let w = evt.rect.width,
            h = w / r;

        // se o usu√°rio ‚Äúpuxou‚Äù mais na vertical do que na horizontal,
        // baseia-se na altura
        if (Math.abs(evt.deltaRect.height) > Math.abs(evt.deltaRect.width)) {
          h = evt.rect.height;
          w = h * r;
        }

        evt.target.style.width  = w + 'px';
        evt.target.style.height = h + 'px';
      }
    }
  });

  img._resizable = true;
}

    /* ---------- COPIAR SEM ALTERAR TAMANHO ---------- */
    editor.addEventListener('copy',e=>{ const sel=window.getSelection(); if(!sel.rangeCount) return; const div=document.createElement('div'); div.appendChild(sel.getRangeAt(0).cloneContents()); div.querySelectorAll('*').forEach(el=>{ el.style.fontSize=null; el.removeAttribute('size'); }); e.clipboardData.setData('text/html',div.innerHTML); e.clipboardData.setData('text/plain',sel.toString()); e.preventDefault(); });

    /* ---------- INICIALIZA√á√ÉO ---------- */
    window.addEventListener('DOMContentLoaded',()=>{ const saved = storage.getItem(storageKey); if(saved) editor.innerHTML=saved; document.querySelectorAll('.hidden-text').forEach(span=>{ span.classList.remove('revealed'); span.addEventListener('click',()=>span.classList.toggle('revealed')); }); document.querySelectorAll('.tarja').forEach(t=>t.style.backgroundColor='rgba(0,0,0,.95)'); document.querySelectorAll('#editor img').forEach(makeResizable); });
    window.addEventListener('beforeunload',
  () => storage.setItem(storageKey, editor.innerHTML)
);

function isImageUrl(url) {
  return (
    /\.(jpe?g|png|gif|bmp|webp)$/i.test(url) ||
    /^https:\/\/firebasestorage\.googleapis\.com\/v0\/b\/[^/]+\/o\/.+\?alt=media.*$/.test(url)
  );
}

function convertTextLinksToImages() {
  const walker = document.createTreeWalker(editor, NodeFilter.SHOW_TEXT, null, false);
  const textsToReplace = [];

  while (walker.nextNode()) {
    const node = walker.currentNode;
    const match = node.nodeValue.match(/(https?:\/\/[^\s]+)/i);
    if (match && isImageUrl(match[1])) {
      const url = match[1];
      textsToReplace.push({ node, url });
    }
  }

  textsToReplace.forEach(({ node, url }) => {
    const img = document.createElement("img");
    img.src = url;
    img.alt = "imagem";
    makeResizable(img);

    const parts = node.nodeValue.split(url);
    const before = document.createTextNode(parts[0]);
    const after = document.createTextNode(parts[1] || "");

    const parent = node.parentNode;
    parent.insertBefore(before, node);
    parent.insertBefore(img, node);
    parent.insertBefore(after, node);
    parent.removeChild(node);
  });
}
undoBtn.onclick = () => exec('undo');
redoBtn.onclick = () => exec('redo');
editor.addEventListener("input", () => {
  setTimeout(convertTextLinksToImages, 100);
});
    editor.addEventListener('keydown', e => {
  if (e.ctrlKey && !e.shiftKey && e.key.toLowerCase() === 'z') {
    exec('undo');   e.preventDefault();
  }
  if (e.ctrlKey && (e.key.toLowerCase() === 'y' || (e.shiftKey && e.key.toLowerCase() === 'z'))) {
    exec('redo');   e.preventDefault();
  }
});
    #editor, #editor p {       /* adicione perto do seu CSS existente */
  overflow-wrap: break-word;
  word-break: break-word;  /* fallback para navegadores antigos */
}#editor, #editor p {       /* adicione perto do seu CSS existente */
  overflow-wrap: break-word;
  word-break: break-word;  /* fallback para navegadores antigos */
}
    /* ---------- SALVAMENTO EM TEMPO-REAL ---------- */
function saveNow() {
  storage.setItem(storageKey, editor.innerHTML);
}
editor.addEventListener('input', () => {
  // Salva imediatamente
  saveNow();

  // Aguarda 100 ms para converter links em imagens (sem travar a digita√ß√£o)
  setTimeout(convertTextLinksToImages, 100);
});

// como seguran√ßa extra, salve tamb√©m ao sair (funciona fora do iframe)
window.addEventListener('beforeunload', saveNow);


  </script>
</body>
</html>

</html>

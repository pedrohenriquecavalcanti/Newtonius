<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Estudos ENEM</title>

  <!-- Font Awesome -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js';
  </script>

  <!-- =======  ESTILOS  ======= -->
  <style>
    /* ===== Estilos Gerais ===== */
    body{margin:0;font-family:Arial,Helvetica,sans-serif;background:#121212;color:#fff}
    /* ===== Botões genéricos ===== */
    button{background:#1e1e1e;color:#f0f0f0;border:0;padding:12px 20px;margin:8px;
           border-radius:4px;cursor:pointer;font-size:16px;display:block;width:240px;
           text-align:center;box-sizing:border-box}
    .small-btn{padding:8px 12px;font-size:14px;display:inline-block;margin:0 8px}
    /* Container principal */
    #app{padding:16px;display:flex;flex-direction:column;align-items:center}
    /* Cabeçalho fixo */
    #header{width:100%;padding:8px;display:flex;align-items:center;
            justify-content:space-between;background:#1e1e1e;box-sizing:border-box}
    #backBtn{visibility:hidden}
    #headerTitle{flex:1;text-align:center;font-size:18px;font-weight:bold;color:#f0f0f0}
    /* Linhas de disciplinas/estrelas */
    .metacog-lines{display:block;flex-direction:column;width:100%;max-width:970px;margin-bottom:32px}
    .disc-line{display:grid;grid-template-columns:220px auto;column-gap:8px;align-items:center;margin-bottom:8px}
    .disc-btn{width:200px;height:33px;display:inline-flex;align-items:center;justify-content:center;border-radius:4px;
              color:#000;font-weight:bold;font-size:18px;padding:0;box-sizing:border-box;margin-right:0}
    .disc-btn.biologia{background:#4E9302}.disc-btn.quimica{background:#1CC9E7}
    .disc-btn.fisica{background:#CA09EE}.disc-btn.matematica{background:#F9D01A}
    .stars-container{display:flex;gap:0}
    /* ===== Estrelas ===== */
    .star{position:relative;display:inline-block;cursor:pointer;margin:0}
    .star::before{content:'★';font-size:35px;display:block;text-align:center;pointer-events:none}
    .star-index{position:absolute;top:54.5%;left:50%;transform:translate(-50%,-50%);
                font-size:.5em;color:#fff;pointer-events:none}
    .state-0{color:#000}.state-1{color:#ff0000}.state-2{color:#ff580a}
    .state-3{color:#32cd32}.state-4{color:#1e90ff}
    /* ===== Estatísticas ===== */
    .stat{margin-bottom:16px;font-weight:bold;text-align:center}
    .stat.blue{color:#1e90ff}.stat.green{color:#32cd32}
    .stat.orange{color:#ff4500}.stat.red{color:#ff0000}
    /* Intro */
    .intro-block{display:flex;align-items:flex-start;margin-bottom:45px;max-width:1000px}
    .intro-img{width:280px;height:auto;margin-right:24px;border-radius:8px}
    .intro-text p{margin:12px 0;font-style:italic;font-size:15px;color:#ccc;line-height:1.6}
    /* ===== Ajuste mobile ===== */
    @media(max-width:768px){
      .intro-block{flex-direction:column;align-items:center;text-align:center}
      .intro-text{margin-top:24px}
    }
    /* ===== Visualizador de PDF ===== */
    #pdfViewerContainer{position:fixed;top:0;left:0;width:100%;height:100%;
                        background:rgba(0,0,0,.9);display:none;flex-direction:column;
                        align-items:center;justify-content:flex-start;z-index:1000;overflow-y:auto}
    #pdfCanvas{max-width:100%;max-height:80%;box-shadow:0 0 10px rgba(0,0,0,.5)}
    #closePdfBtn{position:fixed;top:24px;right:24px;width:44px;height:44px;border:2px solid #ffffff33;
                 border-radius:50%;background:rgba(30,30,30,.75);backdrop-filter:blur(6px);
                 display:flex;align-items:center;justify-content:center;font-size:20px;color:#fff;
                 cursor:pointer;transition:background .25s,transform .25s;z-index:2000}
    #closePdfBtn:hover{background:rgba(30,30,30,.9);transform:scale(1.1)}
  </style>

  <!-- Estilos complementares externos, se quiser -->
  <link rel="stylesheet" href="home-style-update.css">
</head>

<body>
  <!-- input oculto para importação JSON -->
  <input type="file" id="importFile" accept=".json" style="display:none">

  <div id="header">
    <button id="backBtn">Voltar</button>
    <span id="headerTitle"></span>
    <div style="width:250px"></div>
  </div>

  <div id="app"></div>

  <!-- Contêiner do visualizador PDF.js -->
  <div id="pdfViewerContainer">
    <button id="closePdfBtn" aria-label="Fechar PDF">
      <i class="fas fa-times"></i>
    </button>
    <!-- canvases são gerados dinamicamente -->
  </div>

  <!-- Banco de dados externo -->
  <script src="data.js"></script>

  <!-- ========== JAVASCRIPT PRINCIPAL ========== -->
  <script>
/* --------------------------------------------------------------------------
   1. Constrói estrutura { Disciplina → Assunto → [questões] }
   -------------------------------------------------------------------------- */
const questoesData = {};
(window.bancoQuestoes || []).forEach(q => {
  const d = q.Disciplina;
  const s = q.Assunto;
  if (!questoesData[d]) questoesData[d] = {};
  if (!questoesData[d][s]) questoesData[d][s] = [];
  questoesData[d][s].push({
    label:        q.label,
    QPDFName:     q.QPDFName,
    page:         q.page,
    GPDFName:     q.GPDFName,
    gabaritoPage: q.gabaritoPage
  });
});

/* --------------------------------------------------------------------------
   2. Lista de TODOS os assuntos (mesmo que ainda não existam questões)
   -------------------------------------------------------------------------- */
const makeRange = len => Array.from({length:len},(_,i)=>(i+1).toString());
const ASSUNTOS_PADRAO = {
  Biologia:   makeRange(26),
  Química:    makeRange(24),
  Física:     makeRange(20),
  Matemática: makeRange(22)
};

/* -------------------------------------------------------------------------- */
const discClasses = {
  Biologia:'biologia',
  Química:'quimica',
  Física:'fisica',
  Matemática:'matematica'
};

const importFile = document.getElementById('importFile');
const app = document.getElementById('app');
const backBtn = document.getElementById('backBtn');
const headerTitle = document.getElementById('headerTitle');
const pdfContainer = document.getElementById('pdfViewerContainer');
const closeBtn = document.getElementById('closePdfBtn');

let currentDisc = null, currentSub = null;

/* =====================  BACKUP  ===================== */
function exportData(){
  const data = {};
  for(let i=0;i<localStorage.length;i++){
    const k = localStorage.key(i);
    if(k.startsWith('star_') || /^\w+_\d+_\d+$/.test(k))
      data[k] = localStorage.getItem(k);
  }
  const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
  const url  = URL.createObjectURL(blob);
  const a    = document.createElement('a');
  a.href = url; a.download = 'estudos-enem-dados.json'; a.click();
  URL.revokeObjectURL(url);
}

importFile.addEventListener('change', evt=>{
  const file = evt.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = e=>{
    try{
      const obj = JSON.parse(e.target.result);
      Object.entries(obj).forEach(([k,v])=>localStorage.setItem(k,v));
      alert('Dados importados com sucesso!');
      location.reload();
    }catch{ alert('Formato inválido. Não foi possível importar.'); }
  };
  reader.readAsText(file);
});

/* =====================  NAVEGAÇÃO  ===================== */
backBtn.onclick = ()=>{
  if(currentSub) showSubjects(currentDisc);
  else showMenu();
};

function clear(){ app.innerHTML = ''; }
function updateHeader(show,title){
  document.getElementById('header').style.display = show ? 'flex' : 'none';
  backBtn.style.visibility = title ? 'visible' : 'hidden';
  headerTitle.textContent = title || '';
}
function updateStar(el,st){ el.className = 'star state-'+st; }

function showMenu(){
  currentDisc = null; currentSub = null;
  updateHeader(false,'');
  clear();

  /* Introdução */
  const intro = document.createElement('div'); intro.className = 'intro-block';
  intro.innerHTML = `
    <img src="arcano_newtonius.png" alt="Arcano Newtonius" class="intro-img">
    <div class="intro-text">
      <p>Seja bem-vindo(a), jovem aprendiz do conhecimento!</p><br>
      <p>Eu sou <strong>Arcano Newtonius</strong>, o Mago das Ciências da Natureza e da Matemática.<br>
      Guardião dos segredos do universo, mestre dos elementos e das equações, e teu guia nesta jornada rumo à aprovação em Medicina no ENEM.</p><br>
      <p>Cumpre tuas missões, conquista tuas estrelas e avança de nível até alcançar o topo da montanha: a vaga dos teus sonhos!</p>
    </div>`;
  app.appendChild(intro);

  /* Disciplinas + estrelas */
  const lines = document.createElement('div'); lines.className='metacog-lines';
  Object.keys(ASSUNTOS_PADRAO).forEach(disc=>{
    const line = document.createElement('div'); line.className='disc-line';

    /* Botão da disciplina */
    const btn = document.createElement('button');
    btn.className = 'disc-btn '+discClasses[disc];
    btn.textContent = disc;
    btn.onclick = ()=>showSubjects(disc);
    line.appendChild(btn);

    /* Estrelas (uma por assunto) */
    const starsContainer = document.createElement('div'); starsContainer.className='stars-container';
    const subs = ASSUNTOS_PADRAO[disc];
    subs.forEach(sub=>{
      const star = document.createElement('span'); star.className='star';
      const idx = document.createElement('span'); idx.className='star-index'; idx.textContent=sub;
      star.appendChild(idx);
      const key = `star_${disc}_${sub}`;
      let st = parseInt(localStorage.getItem(key),10) || 0;
      updateStar(star,st);
      star.onclick = ()=>{ st=(st+1)%5; localStorage.setItem(key,st); updateStar(star,st); };
      starsContainer.appendChild(star);
    });
    line.appendChild(starsContainer);
    lines.appendChild(line);
  });
  app.appendChild(lines);

  /* Botões backup */
  const exportBtn=document.createElement('button'); exportBtn.textContent='Exportar backup'; exportBtn.onclick=exportData;
  const importBtn=document.createElement('button'); importBtn.textContent='Importar backup'; importBtn.onclick=()=>importFile.click();
  app.appendChild(exportBtn); app.appendChild(importBtn);
}

function showSubjects(disc){
  currentDisc = disc; currentSub = null;
  updateHeader(true,disc);
  clear();

  /* Garante arrays vazios para todos os assuntos */
  (ASSUNTOS_PADRAO[disc] || []).forEach(sub=>{
    if(!questoesData[disc]) questoesData[disc]={};
    if(!questoesData[disc][sub]) questoesData[disc][sub]=[];
  });

  /* Estatísticas gerais da disciplina */
  const statDiv = document.createElement('div'); statDiv.className='stat';
  app.appendChild(statDiv);
  function updateDiscStats(){
    const subs = ASSUNTOS_PADRAO[disc];
    let total=0, correct=0, answered=0;
    subs.forEach(sub=>{
      const qs = questoesData[disc][sub];
      total += qs.length;
      qs.forEach((_,i)=>{
        const st = parseInt(localStorage.getItem(`${disc}_${sub}_${i}`),10);
        if(st===1) correct++;
        if(st===1||st===2) answered++;
      });
    });
    const pct = answered ? (correct/answered*100) : 0;
    statDiv.textContent = `Acertos: ${correct}/${answered} [${total}] (${pct.toFixed(1)}%)`;
    statDiv.className = 'stat '+(pct>=90?'blue':pct>=80?'green':pct>=50?'orange':'red');
  }
  updateDiscStats();

  /* Botões de assuntos */
  (ASSUNTOS_PADRAO[disc]).forEach(sub=>{
    const btn=document.createElement('button');
    btn.textContent=`Assunto ${sub}`;
    btn.onclick=()=>showQuestions(disc,sub);
    app.appendChild(btn);
  });
}

function showQuestions(disc,sub){
  currentDisc = disc; currentSub = sub;
  updateHeader(true,`${disc} – Assunto ${sub}`);
  clear();

  /* Estatística por assunto */
  const statDiv=document.createElement('div'); statDiv.className='stat';
  app.appendChild(statDiv);
  function updateStats(){
    const qs = questoesData[disc][sub];
    const total=qs.length;
    let correct=0, answered=0;
    qs.forEach((_,i)=>{
      const st=parseInt(localStorage.getItem(`${disc}_${sub}_${i}`),10);
      if(st===1) correct++;
      if(st===1||st===2) answered++;
    });
    const pct = answered ? (correct/answered*100) : 0;
    statDiv.textContent=`Acertos: ${correct}/${answered} [${total}] (${pct.toFixed(1)}%)`;
    statDiv.className = 'stat '+(pct>=90?'blue':pct>=80?'green':pct>=50?'orange':'red');
  }
  updateStats();

  const lista = questoesData[disc][sub];
  if(!lista.length){
    const aviso=document.createElement('p');
    aviso.textContent='Ainda não há questões cadastradas para este assunto.';
    aviso.style.fontStyle='italic';
    app.appendChild(aviso);
    return;
  }

  /* Lista de questões */
  lista.forEach((q,idx)=>{
    const row=document.createElement('div'); row.className='question-row';

    const qBtn=document.createElement('button');
    qBtn.textContent=q.label; qBtn.style.flex='1';
    qBtn.onclick=()=>openPdf(q.QPDFName,q.page);
    row.appendChild(qBtn);

    const gBtn=document.createElement('button');
    gBtn.textContent='Gabarito'; gBtn.className='small-btn';
    gBtn.onclick=()=>openPdf(q.GPDFName,q.gabaritoPage);
    row.appendChild(gBtn);

    const key=`${disc}_${sub}_${idx}`;
    const box=document.createElement('span'); box.className='state-box';
    let st=parseInt(localStorage.getItem(key),10)||0;
    function renderBox(){
      box.textContent = st===1?'✓':st===2?'✗':'';
      box.style.color = st===1?'#32cd32':st===2?'#ff0000':'#f0f0f0';
    }
    renderBox();
    box.onclick=()=>{ st=(st+1)%3; localStorage.setItem(key,st); renderBox(); updateStats(); };
    row.appendChild(box);

    app.appendChild(row);
  });
}

/* =====================  PDF LOADER  ===================== */
async function openPdf(pdfName,pages,quality=2,zoom=1.75){
  const pageNums = Array.isArray(pages)?pages:[pages];
  pdfContainer.style.display='flex';
  pdfContainer.querySelectorAll('canvas').forEach(c=>c.remove());

  const pdf = await pdfjsLib.getDocument(pdfName).promise;
  const dpr = window.devicePixelRatio||1;
  const renderScale = quality*dpr*zoom;

  for(const num of pageNums){
    const page = await pdf.getPage(num);
    const viewport = page.getViewport({scale:renderScale});

    const canvas = document.createElement('canvas');
    canvas.width = viewport.width; canvas.height = viewport.height;
    canvas.style.width  = viewport.width /(quality*dpr)+'px';
    canvas.style.height = viewport.height/(quality*dpr)+'px';
    canvas.style.maxWidth='100%'; canvas.style.margin='16px 0';

    pdfContainer.appendChild(canvas);
    await page.render({canvasContext:canvas.getContext('2d'),viewport}).promise;
  }
}
closeBtn.onclick = ()=>{ pdfContainer.style.display='none'; };

/* ==== INICIALIZA ==== */
showMenu();
  </script>
</body>
</html>

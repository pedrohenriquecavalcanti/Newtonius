<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Estudos ENEM</title>

  <!-- Font Awesome -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css"
  />

  <!-- PDF.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc =
      "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.14.305/pdf.worker.min.js";
  </script>

  <!-- ====== CSS ====== -->
  <style>
    /* ===== Gerais ===== */
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background-color: #121212;
      color: #ffffff;
    }

    /* ===== Botões ===== */
    button {
      background: #1e1e1e;
      color: #f0f0f0;
      border: none;
      padding: 12px 20px;
      margin: 8px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      display: block;
      width: 240px;
      text-align: center;
      box-sizing: border-box;
    }
    .small-btn {
      padding: 8px 12px;
      font-size: 14px;
      display: inline-block;
      margin: 0 8px;
    }

    /* ===== Layout ===== */
    #app {
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    #header {
      width: 100%;
      padding: 8px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: #1e1e1e;
      box-sizing: border-box;
    }
    #backBtn {
      visibility: hidden;
    }
    #headerTitle {
      flex: 1;
      text-align: center;
      font-size: 18px;
      font-weight: bold;
      color: #f0f0f0;
    }

    .question-row {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      margin-bottom: 8px;
      width: 100%;
      max-width: 820px;
    }
    .state-box {
      width: 24px;
      height: 24px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border: 2px solid #f0f0f0;
      margin-left: 8px;
      cursor: pointer;
      font-size: 18px;
    }

    /* ===== Caixa de comentário ===== */
    .comment-input {
      background: #1e1e1e;
      color: #f0f0f0;
      border: 1px solid #444;
      padding: 6px 8px;
      border-radius: 4px;
      margin-left: 8px;
      margin-top: 4px;
      width: 240px;
      box-sizing: border-box;
      font-size: 14px;
    }
    .comment-input::placeholder {
      color: #888;
    }

    /* ===== Estatísticas ===== */
    .stat {
      margin-bottom: 16px;
      font-weight: bold;
      text-align: center;
    }
    .stat.blue {
      color: #1e90ff;
    }
    .stat.green {
      color: #32cd32;
    }
    .stat.orange {
      color: #ff4500;
    }
    .stat.red {
      color: #ff0000;
    }

    /* ===== Intro ===== */
    .intro-block {
      display: flex;
      align-items: flex-start;
      margin-bottom: 45px;
      max-width: 1000px;
    }
    .intro-img {
      width: 280px;
      height: auto;
      margin-right: 24px;
      border-radius: 8px;
    }
    .intro-text p {
      margin: 12px 0;
      font-style: italic;
      font-size: 15px;
      color: #cccccc;
      line-height: 1.6;
    }

    /* ===== Disciplinas / estrelas ===== */
    .metacog-lines {
      display: block;
      width: 100%;
      max-width: 970px;
      margin-bottom: 32px;
    }
    .disc-line {
      display: grid;
      grid-template-columns: 220px auto;
      column-gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .stars-container {
      display: flex;
    }
    .disc-btn {
      width: 200px;
      height: 33px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      color: #000;
      font-weight: bold;
      font-size: 18px;
      padding: 0;
      box-sizing: border-box;
      margin-right: 0;
    }
    .disc-btn.biologia {
      background: #4e9302;
    }
    .disc-btn.quimica {
      background: #1cc9e7;
    }
    .disc-btn.fisica {
      background: #ca09ee;
    }
    .disc-btn.matematica {
      background: #f9d01a;
    }

    /* ===== Estrela com índice ===== */
    .star {
      position: relative;
      display: inline-block;
      cursor: pointer;
      margin: 0;
    }
    .star::before {
      content: "★";
      font-size: 35px;
      display: block;
      text-align: center;
      pointer-events: none;
    }
    .star .star-index {
      position: absolute;
      top: 54.5%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 0.5em;
      color: #ffffff;
      pointer-events: none;
    }

    .state-0 {
      color: black;
    }
    .state-1 {
      color: #32cd32;
    }
    .state-2 {
      color: #ff0000;
    }
    .state-3 {
      color: #ff580a;
    }
    .state-4 {
      color: #1e90ff;
    }

    /* ===== PDF viewer ===== */
    #pdfViewerContainer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      z-index: 1000;
      overflow-y: auto;
    }
    #pdfCanvas {
      max-width: 100%;
      max-height: 80%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }
    #closePdfBtn {
      position: fixed;
      top: 24px;
      right: 24px;
      width: 44px;
      height: 44px;
      border: 2px solid #ffffff33;
      border-radius: 50%;
      background: rgba(30, 30, 30, 0.75);
      backdrop-filter: blur(6px);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
      cursor: pointer;
      transition: background 0.25s, transform 0.25s;
      z-index: 2000;
    }
    #closePdfBtn:hover {
      background: rgba(30, 30, 30, 0.9);
      transform: scale(1.1);
    }

    /* ===== Mobile ajustes ===== */
    @media (max-width: 768px) {
      .intro-block {
        flex-direction: column;
        align-items: center;
        text-align: center;
      }
      .intro-text {
        margin-top: 24px;
      }
      .comment-input {
        width: 100%;
        margin: 8px 0 0 0;
      }
    }
  </style>

  <!-- CSS externo (se houver) -->
  <link rel="stylesheet" href="home-style-update.css" />
</head>
<body>
  <!-- input oculto -->
  <input type="file" id="importFile" accept=".json" style="display: none" />

  <div id="header">
    <button id="backBtn">Voltar</button>
    <span id="headerTitle"></span>
    <div style="width: 250px"></div>
  </div>
  <div id="app"></div>

  <!-- PDF viewer -->
  <div id="pdfViewerContainer">
    <button id="closePdfBtn" aria-label="Fechar PDF">
      <i class="fas fa-times"></i>
    </button>
    <canvas id="pdfCanvas"></canvas>
  </div>

  <!-- banco de dados externo -->
  <script src="data.js"></script>

  <!-- ========== JAVASCRIPT ========== -->
  <script>
    /* ---------- CONFIG ---------- */
  const SUBJECT_TOTALS = {
    Biologia:   26,
    Química:    24,
    Física:     20,
    Matemática: 22,
  };

  /* ---------- Nomes amigáveis ---------- */
  const SUBJECT_NAMES = {
    Biologia:   ['Botânica', 'Citologia', 'Genética', /* … até 26 */],
    Química:    ['Físico-química', 'Orgânica', /* … */],
    Física:     ['Mecânica', 'Óptica', /* … */],
    Matemática: ['Funções', 'Probabilidade', /* … */],
  };
    
/* ---------- Função para obter nome amigável ---------- */
function getFriendlyName(disc, sub) {
  const list = SUBJECT_NAMES[disc] || [];
  const idx  = parseInt(sub, 10) - 1;   // "01" → 0
  return list[idx] ?? `Assunto ${sub}`;
  
}
    /* ---------- Build banco ---------- */
    function buildBancoQuestoes(listaFlat) {
      const banco = {};

      (listaFlat || []).forEach((q) => {
        const { Disciplina, Assunto, ...resto } = q;
        if (!banco[Disciplina]) banco[Disciplina] = {};
        if (!banco[Disciplina][Assunto]) banco[Disciplina][Assunto] = [];
        banco[Disciplina][Assunto].push(resto);
      });

      Object.entries(SUBJECT_TOTALS).forEach(([disc, total]) => {
        const lista = Array.isArray(total)
          ? total
          : Array.from({ length: total }, (_, i) => String(i + 1).padStart(2, "0"));
        if (!banco[disc]) banco[disc] = {};
        lista.forEach((sub) => {
          if (!banco[disc][sub]) banco[disc][sub] = [];
        });
      });
      return banco;
    }

    const questoesData = buildBancoQuestoes(window.listaQuestoes || []);

    /* ---------- Utilidades ---------- */
    const discClasses = {
      Biologia: "biologia",
      Química: "quimica",
      Física: "fisica",
      Matemática: "matematica",
    };
    const importFile = document.getElementById("importFile");

    function exportData() {
      const data = {};
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (
          key.startsWith("star_") ||
          key.startsWith("comment_") ||
          /^\w+_\d+_\d+$/.test(key)
        ) {
          data[key] = localStorage.getItem(key);
        }
      }
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "estudos-enem-dados.json";
      a.click();
      URL.revokeObjectURL(url);
    }

    importFile.addEventListener("change", (evt) => {
      const file = evt.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const obj = JSON.parse(e.target.result);
          Object.entries(obj).forEach(([k, v]) => localStorage.setItem(k, v));
          alert("Dados importados com sucesso!");
          location.reload();
        } catch {
          alert("Formato inválido. Não foi possível importar.");
        }
      };
      reader.readAsText(file);
    });

    /* ---------- Variáveis globais ---------- */
    let currentDisc = null,
      currentSub = null;
    const app = document.getElementById("app");
    const backBtn = document.getElementById("backBtn");
    const header = document.getElementById("header");
    const headerTitle = document.getElementById("headerTitle");

    /* PDF.js viewer */
    const pdfContainer = document.getElementById("pdfViewerContainer");
    const pdfCanvas = document.getElementById("pdfCanvas");
    const closeBtn = document.getElementById("closePdfBtn");
    closeBtn.onclick = () => (pdfContainer.style.display = "none");

    backBtn.onclick = () => {
      if (currentSub) showSubjects(currentDisc);
      else showMenu();
    };

    function clear() {
      app.innerHTML = "";
    }
    function updateHeader(show, title) {
      header.style.display = show ? "flex" : "none";
      backBtn.style.visibility = title ? "visible" : "hidden";
      headerTitle.textContent = title || "";
    }
    function updateStar(el, st) {
      el.className = "star state-" + st;
    }

    /* ---------------- MENU PRINCIPAL ---------------- */
    function showMenu() {
      currentDisc = null;
      currentSub = null;
      updateHeader(false, "");
      clear();

      // Intro
      const intro = document.createElement("div");
      intro.className = "intro-block";
      const img = document.createElement("img");
      img.src = "arcano_newtonius.png";
      img.alt = "Arcano Newtonius";
      img.className = "intro-img";
      intro.appendChild(img);

      const txt = document.createElement("div");
      txt.className = "intro-text";
      txt.innerHTML = `
        <p>Seja bem-vindo(a), jovem aprendiz do conhecimento!</p><br />
        <p>
          Eu sou <strong>Arcano Newtonius</strong>, o Mago das Ciências da Natureza e da
          Matemática! Guardião dos segredos do universo, mestre dos elementos e das equações, e
          teu guia nesta jornada rumo à aprovação em Medicina no ENEM.
        </p><br />
        <p>
          Cumpre tuas missões, conquista tuas estrelas e avança de nível até alcançar o topo da
          montanha: a vaga dos teus sonhos!
        </p>`;
      intro.appendChild(txt);
      app.appendChild(intro);

      // Disciplinas
      const lines = document.createElement("div");
      lines.className = "metacog-lines";
      Object.keys(questoesData).forEach((disc) => {
        const line = document.createElement("div");
        line.className = "disc-line";

        const btn = document.createElement("button");
        btn.className = "disc-btn " + discClasses[disc];
        btn.textContent = disc;
        btn.onclick = () => showSubjects(disc);
        line.appendChild(btn);

        const starsContainer = document.createElement("div");
        starsContainer.className = "stars-container";
        const subs = Object.keys(questoesData[disc]).sort();
        subs.forEach((sub) => {
          const star = document.createElement("span");
          star.className = "star";
          const idx = document.createElement("span");
          idx.className = "star-index";
          idx.textContent = sub;
          star.appendChild(idx);

          const key = `star_${disc}_${sub}`;
          let st = parseInt(localStorage.getItem(key), 10) || 0;
          updateStar(star, st);

          star.onclick = () => {
            st = (st + 1) % 5;
            localStorage.setItem(key, st);
            updateStar(star, st);
          };
          starsContainer.appendChild(star);
        });
        line.appendChild(starsContainer);
        lines.appendChild(line);
      });
      app.appendChild(lines);

      // Backup
      const exportBtn = document.createElement("button");
      exportBtn.textContent = "Exportar backup";
      exportBtn.onclick = exportData;
      app.appendChild(exportBtn);

      const importBtn = document.createElement("button");
      importBtn.textContent = "Importar backup";
      importBtn.onclick = () => importFile.click();
      app.appendChild(importBtn);
    }

    /* ---------------- ASSUNTOS ---------------- */
    function showSubjects(disc) {
      currentDisc = disc;
      currentSub = null;
      updateHeader(true, disc);
      clear();

      const statDiv = document.createElement("div");
      statDiv.className = "stat";
      app.appendChild(statDiv);

      function updateDiscStats() {
        const subs = Object.keys(questoesData[disc]);
        let total = 0,
          correct = 0,
          answered = 0;
        subs.forEach((sub) => {
          const qs = questoesData[disc][sub] || [];
          total += qs.length;
          qs.forEach((_, i) => {
            const st = parseInt(localStorage.getItem(`${disc}_${sub}_${i}`), 10);
            if (st === 1) correct++;
            if (st === 1 || st === 2) answered++;
          });
        });
        const pct = answered ? (correct / answered) * 100 : 0;
        statDiv.textContent = `Acertos: ${correct}/${answered} [${total}] (${pct.toFixed(1)}%)`;
        statDiv.className =
          "stat " + (pct >= 90 ? "blue" : pct >= 80 ? "green" : pct >= 50 ? "orange" : "red");
      }
      updateDiscStats();

      Object.keys(questoesData[disc])
        .sort()
        .forEach((sub) => {
          const btn = document.createElement("button");
          btn.textContent = getFriendlyName(disc, sub);
          btn.onclick = () => showQuestions(disc, sub);
          app.appendChild(btn);
        });
    }

    /* ---------------- QUESTÕES ---------------- */
    function showQuestions(disc, sub) {
      currentDisc = disc;
      currentSub = sub;
      updateHeader(true, `${disc} - ${getFriendlyName(disc, sub)}`);
      clear();

      const statDiv = document.createElement("div");
      statDiv.className = "stat";
      app.appendChild(statDiv);

      function updateStats() {
        const qs = questoesData[disc][sub] || [];
        const total = qs.length;
        let correct = 0,
          answered = 0;
        qs.forEach((_, i) => {
          const st = parseInt(localStorage.getItem(`${disc}_${sub}_${i}`), 10);
          if (st === 1) correct++;
          if (st === 1 || st === 2) answered++;
        });
        const pct = answered ? (correct / answered) * 100 : 0;
        statDiv.textContent = `Acertos: ${correct}/${answered} [${total}] (${pct.toFixed(1)}%)`;
        statDiv.className =
          "stat " + (pct >= 90 ? "blue" : pct >= 80 ? "green" : pct >= 50 ? "orange" : "red");
      }
      updateStats();

      (questoesData[disc][sub] || []).forEach((q, idx) => {
        const row = document.createElement("div");
        row.className = "question-row";

        // botão questão
        const qBtn = document.createElement("button");
        qBtn.textContent = q.label;
        qBtn.style.flex = "1";
        qBtn.onclick = () => openPdf(q.QPDFName, q.page);
        row.appendChild(qBtn);

        // botão gabarito
        const gBtn = document.createElement("button");
        gBtn.textContent = "Gabarito";
        gBtn.className = "small-btn";
        gBtn.onclick = () => openPdf(q.GPDFName, q.gabaritoPage);
        row.appendChild(gBtn);

        // caixa acerto/erro
        const key = `${disc}_${sub}_${idx}`;
        const box = document.createElement("span");
        box.className = "state-box";
        let st = parseInt(localStorage.getItem(key), 10) || 0;
        function renderBox() {
          box.textContent = st === 1 ? "✓" : st === 2 ? "✗" : "";
          box.style.color = st === 1 ? "#32cd32" : st === 2 ? "#ff0000" : "#f0f0f0";
        }
        renderBox();
        box.onclick = () => {
          st = (st + 1) % 3;
          localStorage.setItem(key, st);
          renderBox();
          updateStats();
        };
        row.appendChild(box);

        // ------ NOVO: caixa de comentário ------
        const commentKey = `comment_${disc}_${sub}_${idx}`;
        const commentInput = document.createElement("input");
        commentInput.type = "text";
        commentInput.placeholder = "Comentário (opcional)";
        commentInput.className = "comment-input";
        commentInput.value = localStorage.getItem(commentKey) || "";
        commentInput.oninput = (e) => localStorage.setItem(commentKey, e.target.value);
        row.appendChild(commentInput);

        app.appendChild(row);
      });
    }

    /* ---------------- PDF loader ---------------- */
    async function openPdf(pdfName, pages, quality = 2, zoom = 1.75) {
      const pageNums = Array.isArray(pages) ? pages : [pages];
      pdfContainer.style.display = "flex";
      pdfContainer.querySelectorAll("canvas").forEach((c) => c.remove());

      const pdf = await pdfjsLib.getDocument(pdfName).promise;
      const dpr = window.devicePixelRatio || 1;
      const renderScale = quality * dpr * zoom;

      for (const num of pageNums) {
        const page = await pdf.getPage(num);
        const viewport = page.getViewport({ scale: renderScale });

        const canvas = document.createElement("canvas");
        const ctx = canvas.getContext("2d");
        canvas.width = viewport.width;
        canvas.height = viewport.height;

        const cssDivisor = quality * dpr;
        canvas.style.width = viewport.width / cssDivisor + "px";
        canvas.style.height = viewport.height / cssDivisor + "px";
        canvas.style.maxWidth = "100%";
        canvas.style.margin = "16px 0";
        pdfContainer.appendChild(canvas);

        await page.render({ canvasContext: ctx, viewport }).promise;
      }
    }

    /* ---------------- Start ---------------- */
    showMenu();
  </script>
</body>
</html>
